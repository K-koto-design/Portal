<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–∞–±–æ—á–∏–π –ü–æ—Ä—Ç–∞–ª PRO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f2f2f7; --accent: #007aff; --card: #ffffff; --text: #1c1c1e;
            --gray: #8e8e93; --red: #ff3b30; --green: #34c759; --blue-light: #e8f0ff;
        }

        body, html { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100%; }
        .refresh-btn { position: fixed; top: 50px; right: 20px; width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000; border: none; font-size: 20px; cursor: pointer; }

        #login-screen { display: flex; flex-direction: column; justify-content: center; padding: 40px; height: 100vh; box-sizing: border-box; }
        input, select { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; outline: none; background: white; }
        .btn { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 600; width: 100%; cursor: pointer; margin-bottom: 10px; }
        .btn-red { background: var(--red); }

        #main-app { display: none; padding: 20px; }
        .header { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .total-sum { font-size: 28px; font-weight: 800; color: var(--accent); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { background: #e5e5ea; padding: 10px 20px; border-radius: 20px; font-size: 14px; white-space: nowrap; cursor: pointer; }
        .tab.active { background: var(--accent); color: white; }

        .item-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #e5e5ea; position: relative; }
        .status { font-size: 11px; font-weight: bold; padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 5px; }
        .status-debt { background: #ffebeb; color: var(--red); }
        .status-ok { background: #e8f9ed; color: var(--green); }
        .status-frozen { background: #f2f2f7; color: var(--gray); text-decoration: line-through; }
        
        .action-btns { float: right; display: flex; flex-direction: column; gap: 5px; }
        .small-btn { padding: 6px 10px; border-radius: 8px; border: none; font-size: 10px; font-weight: bold; cursor: pointer; text-align: center; }
        .btn-freeze { background: #fef1f1; color: var(--red); }
        .btn-unfreeze { background: var(--blue-light); color: var(--accent); }
        .btn-del { background: #eee; color: #555; }

        .admin-form { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--accent); }
        footer { text-align: center; font-size: 10px; color: var(--gray); margin-top: 20px; padding-bottom: 20px; }
    </style>
</head>
<body>

    <button class="refresh-btn" onclick="hardReset()">üîÑ</button>

    <div id="login-screen">
        <h1 style="text-align:center;">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="tryLogin()">–í–æ–π—Ç–∏</button>
        <p id="error" style="color:red; text-align:center; display:none;">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</p>
    </div>

    <div id="main-app">
        <div class="header">
            <div style="font-size: 12px; color: var(--gray); text-transform: uppercase;">–û–±—â–∞—è —Å—É–º–º–∞ –∞–∫—Ç–∏–≤–æ–≤</div>
            <div class="total-sum" id="total-display">0 ‚ÇΩ</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('clients', this)">–ö–ª–∏–µ–Ω—Ç—ã</div>
            <div class="tab" onclick="showTab('loans', this)">–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</div>
            <div class="tab" onclick="showTab('freeze', this)">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
            <div class="tab" onclick="showTab('admin', this)">‚ûï –î–æ–±–∞–≤–∏—Ç—å</div>
        </div>

        <div id="content-area"></div>
        
        <footer>
            –°–∏—Å—Ç–µ–º–∞: WebApp-B7149<br>
            –û–±–ª–∞—á–Ω–∞—è –±–∞–∑–∞: Firebase Realtime
        </footer>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            authDomain: "webapp-b7149.firebaseapp.com",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webapp-b7149",
            storageBucket: "webapp-b7149.firebasestorage.app",
            messagingSenderId: "1034835242406",
            appId: "1:1034835242406:web:98499dc1edbb83e4b8f367"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const clientsRef = db.ref('clients');

        let localClients = [];

        // --- –õ–û–ì–ò–ö–ê ---

        function hardReset() { location.reload(); }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        clientsRef.on('value', (snapshot) => {
            const val = snapshot.val();
            localClients = val ? Object.keys(val).map(key => ({...val[key], fbKey: key})) : [];
            updateUI();
        });

        function updateUI() {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–∞
                const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                renderContent(type);
            }
            
            const total = localClients.reduce((acc, c) => acc + (Number(c.loan) || 0), 0);
            document.getElementById('total-display').innerText = total.toLocaleString() + " ‚ÇΩ";
        }

        function tryLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (u === "Admin" && p === "45621") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                showTab('clients', document.querySelector('.tab'));
            } else {
                document.getElementById('error').style.display = 'block';
            }
        }

        function addNewClient() {
            const name = document.getElementById('new-name').value;
            const phone = document.getElementById('new-phone').value;
            const loan = document.getElementById('new-loan').value;
            const status = document.getElementById('new-status').value;

            if(!name || !phone) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω");

            clientsRef.push({
                name, phone, 
                loan: Number(loan) || 0, 
                status: status,
                frozen: false,
                card: "–ú–ò–† *" + Math.floor(1000 + Math.random() * 9000)
            });

            alert("–ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É!");
            showTab('clients', document.querySelectorAll('.tab')[0]);
        }

        function toggleFreeze(fbKey, currentStatus) {
            db.ref('clients/' + fbKey).update({ frozen: !currentStatus });
        }

        function deleteClient(fbKey, name) {
            if(confirm(`–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ ${name} –Ω–∞–≤—Å–µ–≥–¥–∞?`)) {
                db.ref('clients/' + fbKey).remove();
            }
        }

        function showTab(type, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderContent(type);
        }

        function renderContent(type) {
            let html = '';
            const container = document.getElementById('content-area');

            if (type === 'clients') {
                localClients.forEach(c => {
                    const sClass = c.frozen ? "status-frozen" : (c.status === "–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å" ? "status-debt" : "status-ok");
                    html += `
                        <div class="item-card" style="opacity: ${c.frozen ? '0.6' : '1'}">
                            <b>${c.name} ${c.frozen ? '‚ùÑÔ∏è' : ''}</b><br>
                            <span style="font-size:13px; color:gray">${c.phone}</span><br>
                            <span class="status ${sClass}">${c.frozen ? '–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù' : c.status}</span>
                            <div style="font-size:11px; color:gray; margin-top:5px;">–ö–∞—Ä—Ç–∞: ${c.card}</div>
                        </div>`;
                });
            } 
            
            else if (type === 'loans') {
                const debtors = localClients.filter(c => c.loan > 0);
                if(debtors.length === 0) html = '<p style="text-align:center; color:gray;">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤ –Ω–µ—Ç</p>';
                debtors.forEach(c => {
                    html += `
                        <div class="item-card">
                            <div style="font-size:12px; color:gray">–î–µ—Ä–∂–∞—Ç–µ–ª—å:</div>
                            <div>${c.name}</div>
                            <div style="font-weight:bold; color:var(--accent); margin-top:5px">${c.loan.toLocaleString()} ‚ÇΩ</div>
                        </div>`;
                });
            }

            else if (type === 'freeze') {
                localClients.forEach(c => {
                    html += `
                        <div class="item-card">
                            <div class="action-btns">
                                <button class="small-btn ${c.frozen ? 'btn-unfreeze' : 'btn-freeze'}" 
                                    onclick="toggleFreeze('${c.fbKey}', ${c.frozen})">
                                    ${c.frozen ? '–†–ê–ó–ú–û–†–û–ó–ò–¢–¨' : '–ó–ê–ú–û–†–û–ó–ò–¢–¨'}
                                </button>
                                <button class="small-btn btn-del" onclick="deleteClient('${c.fbKey}', '${c.name}')">–£–î–ê–õ–ò–¢–¨</button>
                            </div>
                            <b>${c.name}</b><br>
                            <span style="font-size:12px; color:gray">${c.phone}</span>
                        </div>`;
                });
            }

            else if (type === 'admin') {
                html = `
                    <div class="admin-form">
                        <h3 style="margin-top:0">–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h3>
                        <input type="text" id="new-name" placeholder="–§–ò–û">
                        <input type="text" id="new-phone" placeholder="+7 (___) ___-__-__">
                        <input type="number" id="new-loan" placeholder="–°—É–º–º–∞ –¥–æ–ª–≥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)">
                        <select id="new-status">
                            <option value="–û–±—ã—á–Ω–æ">–°—Ç–∞—Ç—É—Å: –û–±—ã—á–Ω–æ</option>
                            <option value="–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å">–°—Ç–∞—Ç—É—Å: –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</option>
                        </select>
                        <button class="btn" onclick="addNewClient()">–°–û–•–†–ê–ù–ò–¢–¨ –í FIREBASE</button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }
    </script>
</body>
</html>
