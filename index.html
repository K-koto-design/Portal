<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MAX Staff ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–∞–Ω–∫–æ–º</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #007aff; --bg: #f5f5f7; --card: #ffffff; --text: #1c1c1e; --green: #34c759; --red: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        .sidebar { width: 280px; background: #fff; height: 100vh; border-right: 1px solid #ddd; padding: 20px; position: fixed; }
        .main-content { margin-left: 280px; padding: 40px; width: 100%; }
        
        .card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; font-size: 20px; }
        
        .app-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .btn-group { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn.accept { background: var(--green); color: white; }
        .btn.decline { background: var(--red); color: white; }
        
        .user-row { cursor: pointer; transition: 0.2s; border-radius: 10px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; border-bottom: 1px solid #eee; }
        .user-row:hover { background: #f0f7ff; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .badge.ip { background: #000; color: #fff; }
        .badge.user { background: #e5e5ea; color: #333; }

        input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 100px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1 style="font-size: 22px; color: var(--primary);">MAX Staff</h1>
        <hr>
        <div style="margin-top: 20px;">
            <p style="font-weight: 600; color: #888;">–ú–ï–ù–Æ</p>
            <div style="padding: 10px 0; cursor: pointer; color: var(--primary);">‚óè –ó–∞—è–≤–∫–∏</div>
            <div style="padding: 10px 0; cursor: pointer;">‚óè –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
        </div>
    </div>

    <div class="main-content">
        <div class="card">
            <h2>üîî –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</h2>
            <div id="applications-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="card">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h2>
            <div id="users-table">
                <div class="user-row" style="font-weight: bold; border-bottom: 2px solid #eee;">
                    <span>–ò–º—è / –ö–æ–º–ø–∞–Ω–∏—è</span>
                    <span>–ë–æ–Ω—É—Å—ã</span>
                    <span>–ö—Ä–µ–¥–∏—Ç (–¶–∏—Ñ—Ä—ã)</span>
                    <span>–°—Ç–∞—Ç—É—Å / –î–µ–π—Å—Ç–≤–∏—è</span>
                </div>
                <div id="clients-list"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webapp-b7149",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –ó–ê–Ø–í–û–ö
        db.ref('applications').on('value', snap => {
            const list = document.getElementById('applications-list');
            list.innerHTML = "";
            snap.forEach(child => {
                const app = child.val();
                list.innerHTML += `
                    <div class="app-item">
                        <div>
                            <span class="badge ${app.orgType === '–ò–ü' ? 'ip' : 'user'}">${app.orgType}</span>
                            <b>${app.name}</b> <br>
                            <small>–¢–µ–ª: ${app.phone} | –ü–ò–ù: ${app.clientPin} ${app.inn ? '| –ò–ù–ù: ' + app.inn : ''}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn accept" onclick="approveApp('${child.key}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                            <button class="btn decline" onclick="deleteApp('${child.key}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            });
            if (!list.innerHTML) list.innerHTML = "<p style='color:#888'>–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</p>";
        });

        // 2. –û–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
        function approveApp(key) {
            db.ref('applications/' + key).once('value', snap => {
                const data = snap.val();
                db.ref('clients').push(data).then(() => {
                    db.ref('applications/' + key).remove();
                });
            });
        }

        function deleteApp(key) { if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?")) db.ref('applications/' + key).remove(); }

        // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–õ–ò–ï–ù–¢–ê–ú–ò
        db.ref('clients').on('value', snap => {
            const list = document.getElementById('clients-list');
            list.innerHTML = "";
            snap.forEach(child => {
                const u = child.val();
                const key = child.key;
                list.innerHTML += `
                    <div class="user-row">
                        <span><b>${u.name}</b><br><small>${u.phone}</small></span>
                        <span>
                            <input type="number" value="${u.bonuses || 0}" onchange="updateVal('${key}', 'bonuses', this.value)">
                        </span>
                        <span>
                            <input type="number" value="${u.creditLimit || 0}" onchange="updateVal('${key}', 'creditLimit', this.value)">
                        </span>
                        <span style="display:flex; gap:5px; align-items:center;">
                            <button class="btn" style="background:${u.frozen ? '#ffcc00' : '#e5e5ea'}" onclick="toggleFreeze('${key}', ${u.frozen})">
                                ${u.frozen ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                            <button class="btn" onclick="viewDetails('${key}')">üëÅÔ∏è –ò–Ω—Ñ–æ</button>
                        </span>
                    </div>
                `;
            });
        });

        function updateVal(key, field, val) {
            db.ref('clients/' + key).update({ [field]: Number(val) });
        }

        function toggleFreeze(key, currentStatus) {
            db.ref('clients/' + key).update({ frozen: !currentStatus });
        }

        function viewDetails(key) {
            db.ref('clients/' + key).once('value', snap => {
                const u = snap.val();
                alert(`–ö–æ–ø–∏–ª–∫–∏: ${JSON.stringify(u.piggies || '–ü—É—Å—Ç–æ')}\n–ò—Å—Ç–æ—Ä–∏—è: ${u.history ? u.history.length : 0} –æ–ø–µ—Ä–∞—Ü–∏–π`);
            });
        }
    </script>
</body>
</html>
