<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–∞–±–æ—á–∏–π –ü–æ—Ä—Ç–∞–ª PRO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f2f2f7; --accent: #007aff; --card: #ffffff; --text: #1c1c1e;
            --gray: #8e8e93; --red: #ff3b30; --green: #34c759; --blue-light: #e8f0ff;
        }

        body, html { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100%; overflow-x: hidden; }
        
        /* –≠–∫—Ä–∞–Ω –ü–ò–ù-–∫–æ–¥–∞ –ê–¥–º–∏–Ω–∞ */
        #pin-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: var(--bg); position: fixed; width: 100%; z-index: 2000; }
        .pin-input { font-size: 32px; letter-spacing: 15px; text-align: center; border: none; background: none; border-bottom: 2px solid var(--accent); width: 150px; outline: none; margin-bottom: 20px; }

        #main-app { display: none; padding: 20px; padding-bottom: 100px; }
        
        .header { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .total-sum { font-size: 28px; font-weight: 800; color: var(--accent); }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .tab { background: #e5e5ea; padding: 10px 20px; border-radius: 20px; font-size: 14px; white-space: nowrap; cursor: pointer; }
        .tab.active { background: var(--accent); color: white; }

        .item-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #e5e5ea; cursor: pointer; transition: 0.2s; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 25px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f2f2f7; }
        .detail-label { color: var(--gray); font-size: 14px; }
        .detail-value { font-weight: 600; font-size: 15px; }

        input, select { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; outline: none; background: white; }
        .btn { background: var(--accent); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 600; width: 100%; cursor: pointer; }
        
        .close-modal { background: #f2f2f7; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; float: right; cursor: pointer; }
    </style>
</head>
<body>

    <div id="pin-screen">
        <div style="font-size: 50px; margin-bottom: 10px;">üõ°Ô∏è</div>
        <h3>–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å</h3>
        <input type="password" id="pin-input" class="pin-input" maxlength="4" inputmode="numeric">
        <button class="btn" style="width: 200px;" onclick="checkPin()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="main-app">
        <div class="header">
            <div style="font-size: 12px; color: var(--gray); text-transform: uppercase;">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å —Å–∏—Å—Ç–µ–º—ã</div>
            <div class="total-sum" id="total-display">0 ‚ÇΩ</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('clients', this)">–ö–ª–∏–µ–Ω—Ç—ã</div>
            <div class="tab" onclick="showTab('admin', this)">‚ûï –î–æ–±–∞–≤–∏—Ç—å</div>
            <div class="tab" onclick="showTab('freeze', this)">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        </div>

        <div id="content-area"></div>
    </div>

    <div id="detail-modal" class="modal" onclick="closeDetails(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="close-modal" onclick="document.getElementById('detail-modal').style.display='none'">‚úï</div>
            <h2 id="m-name" style="margin-top: 0;">–§–ò–û</h2>
            <div id="m-id" style="color: var(--gray); font-size: 12px; margin-bottom: 20px;">ID: 0000</div>
            
            <div class="detail-row"><span class="detail-label">–°—Ç–∞—Ç—É—Å</span><span class="detail-value" id="m-type" style="color: var(--accent)">-</span></div>
            <div class="detail-row"><span class="detail-label">–ë–∞–ª–∞–Ω—Å</span><span class="detail-value" id="m-balance">0 ‚ÇΩ</span></div>
            <div class="detail-row"><span class="detail-label">–ë–æ–Ω—É—Å—ã</span><span class="detail-value" id="m-bonuses" style="color: var(--green)">0 –ë</span></div>
            <div class="detail-row"><span class="detail-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∑–∞ –º–µ—Å—è—Ü</span><span class="detail-value" id="m-spent">0 ‚ÇΩ</span></div>
            <div class="detail-row"><span class="detail-label">–ö–æ–ø–∏–ª–æ–∫</span><span class="detail-value" id="m-piggy">0</span></div>
            
            <br>
            <button class="btn" style="background: #f2f2f7; color: #1c1c1e;" onclick="document.getElementById('detail-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            authDomain: "webapp-b7149.firebaseapp.com",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webapp-b7149",
            storageBucket: "webapp-b7149.firebasestorage.app",
            messagingSenderId: "1034835242406",
            appId: "1:1034835242406:web:98499dc1edbb83e4b8f367"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const clientsRef = db.ref('clients');
        let localClients = [];

        function checkPin() {
            if (document.getElementById('pin-input').value === "1234") {
                document.getElementById('pin-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                loadData();
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù");
            }
        }

        function loadData() {
            clientsRef.on('value', (snapshot) => {
                const val = snapshot.val();
                localClients = val ? Object.keys(val).map(key => ({...val[key], fbKey: key})) : [];
                updateUI();
            });
        }

        function updateUI() {
            const total = localClients.reduce((acc, c) => acc + (Number(c.balance) || 0), 0);
            document.getElementById('total-display').innerText = total.toLocaleString() + " ‚ÇΩ";
            renderCurrentTab();
        }

        function addNewClient() {
            const name = document.getElementById('new-name').value;
            const phone = document.getElementById('new-phone').value;
            const orgType = document.getElementById('new-type').value;
            const balance = document.getElementById('new-balance').value;
            const bonuses = document.getElementById('new-bonuses').value;
            const clientPin = document.getElementById('new-client-pin').value;

            if(!name || !phone || !clientPin) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û, –¢–µ–ª–µ—Ñ–æ–Ω –∏ –ü–ò–ù –∫–ª–∏–µ–Ω—Ç–∞!");

            const newId = Math.floor(1000 + Math.random() * 9000);

            clientsRef.push({
                id: newId,
                name, phone, orgType,
                balance: Number(balance) || 0,
                bonuses: Number(bonuses) || 0,
                clientPin: clientPin, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ü–ò–ù –∫–ª–∏–µ–Ω—Ç–∞
                spentMonth: 0,
                piggyBanks: 0,
                frozen: false
            });

            alert("–ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!");
            showTab('clients', document.querySelectorAll('.tab')[0]);
        }

        function openDetails(key) {
            const c = localClients.find(item => item.fbKey === key);
            if(!c) return;

            document.getElementById('m-name').innerText = c.name;
            document.getElementById('m-id').innerText = "ID: " + (c.id || "0000");
            document.getElementById('m-type').innerText = c.orgType; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ò–ü / –ù–µ –ò–ü
            document.getElementById('m-balance').innerText = (c.balance || 0).toLocaleString() + " ‚ÇΩ";
            document.getElementById('m-bonuses').innerText = (c.bonuses || 0).toLocaleString() + " –ë";
            document.getElementById('m-spent').innerText = (c.spentMonth || 0).toLocaleString() + " ‚ÇΩ";
            document.getElementById('m-piggy').innerText = c.piggyBanks || 0;
            
            document.getElementById('detail-modal').style.display = 'flex';
        }

        function closeDetails(e) {
            if(e.target.id === 'detail-modal') document.getElementById('detail-modal').style.display = 'none';
        }

        function showTab(type, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderCurrentTab();
        }

        function renderCurrentTab() {
            const activeTab = document.querySelector('.tab.active');
            if(!activeTab) return;
            const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
            const container = document.getElementById('content-area');
            let html = '';

            if (type === 'clients') {
                localClients.forEach(c => {
                    html += `
                        <div class="item-card" onclick="openDetails('${c.fbKey}')">
                            <span style="float:right; color:var(--accent); font-weight:bold">${c.balance.toLocaleString()} ‚ÇΩ</span>
                            <b>${c.name}</b><br>
                            <span style="font-size:12px; color:gray">${c.phone}</span><br>
                            <span style="font-size:11px; color:var(--accent); font-weight:600">${c.orgType}</span>
                        </div>`;
                });
            } else if (type === 'admin') {
                html = `
                    <div style="background:white; padding:20px; border-radius:20px;">
                        <h3 style="margin-top:0">–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h3>
                        <input type="text" id="new-name" placeholder="–§–ò–û">
                        <input type="text" id="new-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                        <select id="new-type">
                            <option value="–ò–ü">–°—Ç–∞—Ç—É—Å: –ò–ü</option>
                            <option value="–ù–µ –ò–ü">–°—Ç–∞—Ç—É—Å: –ù–µ –ò–ü</option>
                        </select>
                        <input type="number" id="new-balance" placeholder="–ë–∞–ª–∞–Ω—Å (‚ÇΩ)">
                        <input type="number" id="new-bonuses" placeholder="–ë–æ–Ω—É—Å—ã">
                        <input type="password" id="new-client-pin" placeholder="–ü–ò–ù-–ö–û–î –ö–õ–ò–ï–ù–¢–ê" style="border: 2px solid var(--accent)">
                        <button class="btn" onclick="addNewClient()">–°–û–•–†–ê–ù–ò–¢–¨ –í FIREBASE</button>
                    </div>`;
            } else if (type === 'freeze') {
                localClients.forEach(c => {
                    html += `
                        <div class="item-card">
                            <button class="btn" style="width:auto; float:right; padding:8px 12px; font-size:12px; background:${c.frozen ? 'var(--green)' : 'var(--red)'}" 
                                onclick="db.ref('clients/${c.fbKey}').update({frozen: !${c.frozen}})">
                                ${c.frozen ? '–†–ê–ó–ë–õ–û–ö' : '–ó–ê–ë–õ–û–ö'}
                            </button>
                            <b>${c.name}</b><br>
                            <span style="font-size:12px; color:gray">ID: ${c.id} | PIN: ${c.clientPin}</span>
                        </div>`;
                });
            }
            container.innerHTML = html;
        }
    </script>
</body>
</html>
